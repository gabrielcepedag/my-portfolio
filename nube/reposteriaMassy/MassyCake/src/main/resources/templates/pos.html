<!DOCTYPE HTML>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>POS | Massy's Cake</title>
    <link rel="shortcut icon" type="image" href="/img/massyCake-Logo.jpg">
    <link rel="apple-touch-icon" sizes="180x180" href="/img/massyCake-Logo.jpg">
    <link rel="icon" type="image/jpg" sizes="32x32" href="/img/massyCake-Logo.jpg">

    <!-- Bootstrap4 files-->
    <link href="/assets/css/bootstrap.css" rel="stylesheet" type="text/css"/>

    <!-- Font awesome 5 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css"  crossorigin="anonymous" />

    <!-- Custom Style  -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" >
    <link href="/assets/css/ui.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/css/OverlayScrollbars.css" type="text/css" rel="stylesheet"/>
    <link href="/css/notification.css" rel="stylesheet">

    <style>
        .avatar {
            vertical-align: middle;
            width: 35px;
            height: 35px;
            border-radius: 50%;
        }
        .bg-default, .btn-default {
            background-color: #f2f3f8;
        }
        .btn-error {
            color: #ef5f5f;
        }
		.nav-link {
			background-color: #7570B3;
			padding: 10px;
			color: white;
		}
		.nav-link:hover {
			background-color: #585386;
			color: white;
		}
		.nav-item {
			padding: 10px;
		}
		.title {
			color: #7570B3;
		}
    </style>
</head>

<body>
<section style="position: relative">
    <div class="container">
        <div class="row align-items-center">
            <!-- end of brand-wrap -->
            <div class="col-lg-3">
                <div class="brand-wrap">
                    <img class="" src="/img/massyCake-Logo.png" style="height: 6rem; padding: 0; margin: 0" alt="Logo de empresa">
                </div>
            </div>
            <!-- end of brand-wrap -->

            <!-- end of search-wrap-->
<!--            <div class="col-lg-6 col-sm-6">-->
<!--                <form action="#" class="search-wrap">-->
<!--                    <div class="input-group">-->
<!--                        <input type="text" class="form-control" placeholder="Buscar...">-->
<!--                        <div class="input-group-append">-->
<!--                            <button class="btn" type="submit" style="background-color: #7570B3; color: white">-->
<!--                                <i class="fa fa-search"></i>-->
<!--                            </button>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                </form>-->
<!--            </div>-->
            <!-- end of search-wrap-->

            <div class="col-lg-3 col-sm-6 ml-auto">
                <!-- widgets-wrap -->
                <div class="widgets-wrap d-flex justify-content-end">
                    <div class="widget-header" th:if="${empleado.rol.toLowerCase() == 'admin'}">
                        <a href="/home" class="btn m-btn m-btn--icon m-btn--icon-only" style="background-color: #7570B3; color: white">
                            <i class="fa fa-home"></i>
                        </a>
                    </div>
                    <!-- widget .// -->

                    <!-- widget dropdown -->
                    <div class="widget-header dropdown">
                        <a href="#" class="ml-3 icontext" data-toggle="dropdown" data-offset="20,10">
                            <img class="avatar" th:src="${empleado.rol == 'ADMIN' ? '/img/profile_icon.jpg':
                                (empleado.rol == 'REPOSTERO' ? '/img/chef-avatar-vector-illustration.jpg' : '/img/profile_icon.png')}" alt="Imagen de perfil usuario">
                        </a>
                        <!-- dropdown-menu -->
                        <div class="dropdown-menu dropdown-menu-right">
                            <a class="dropdown-item" href="/perfil">
                                <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>
                                Mi Perfil
                            </a>
                            <div class="dropdown-divider"></div>
                            <div class="modal-footer">
                                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancelar</button>
                                <a class="btn btn-primary" href="/logout">Salir</a>
                            </div>
                        </div>
                        <!-- end of dropdown-menu -->
                    </div>
                    <!-- end of widget dropdown -->

                </div>
                <!-- end of widgets-wrap -->

            </div>
        </div>
    </div>
</section>

<!-- ========================= SECTION CONTENT ========================= -->
<section class="section-content padding-y-sm bg-default ">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8 card padding-y-xs card">
                <ul class="nav bg radius nav-pills nav-fill mb-3 bg" role="tablist">
                    <li class="nav-item" onclick="actualizarCategoria('TODOS')">
                        <a class="nav-link" data-toggle="pill" href="?categoria=Todos">
                            <i class="fa fa-tags"></i> Todos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="actualizarCategoria('POSTRE')" data-toggle="pill" href="?categoria=Postre">
                            <i class="fa fa-tags "></i> Postres
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="actualizarCategoria('PASTEL')" data-toggle="pill" href="?categoria=Pastel">
                            <i class="fa fa-tags "></i> Pasteles
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="actualizarCategoria('GALLETA')" data-toggle="pill" href="?categoria=Galleta">
                            <i class="fa fa-tags "></i> Galletas
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="actualizarCategoria('BEBIDA')" data-toggle="pill" href="?categoria=Bebida">
                            <i class="fa fa-tags "></i> Bebidas
                        </a>
                    </li>
                    <li class="nav-item" onclick="actualizarCategoria('PERSONALIZADO')">
                        <a class="nav-link" data-toggle="pill" href="?categoria=Personalizado">
                            <i class="fa fa-tags"></i> Personalizado
                        </a>
                    </li>
                    <li class="nav-item" onclick="actualizarCategoria('OTROS')">
                        <a class="nav-link" data-toggle="pill" href="?categoria=Otros">
                            <i class="fa fa-tags"></i> Otros
                        </a>
                    </li>
                </ul>
                <span id="items">
                    <div class="row" id="productos-container">
                       <div class="col-md-3 productos-table" th:each="producto : ${productos}">
                            <figure class="card card-product">
                                <span class="badge-new categoria" th:text="${producto.categoria}"></span>
                                <div class="img-wrap">
                                     <img th:src="${producto.foto == null ? '/img/posDefault.jpg' : producto.foto}" style="object-fit: cover; height: 100%">
                                </div>
                                <figcaption class="info-wrap">
                                    <a href="#" class="title" th:text="${producto.nombre}"></a>
                                    <div class="action-wrap">
                                        <button href="#" class="btn btn-sm float-right agregar-carrito" style="background-color: #7570B3; color: white" th:attr="data-producto-id=${producto.id}">
                                            <i class="fa fa-cart-plus"></i>
                                        </button>
                                        <div class="price-wrap h5">
                                            <span class="price-new" th:text="${producto.precio}"></span>
                                        </div>
                                    </div>
                                </figcaption>
                            </figure>
                        </div>
                    </div>
                </span>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <span id="cart">
                        <table class="table table-hover shopping-cart-wrap table-responsive">
                            <thead class="text-muted">
                                <tr>
                                    <th scope="col">Item</th>
                                    <th scope="col" style="width: 120px">Cantidad</th>
                                    <th scope="col" style="width: 120px">Precio</th>
                                    <th scope="col" class="text-right" style="width: 200px">Eliminar</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>
                    </span>
                </div>
                <!-- card.// -->

                <div class="box" id="totalesContainer">


                </div>
                <!-- box.// -->
            </div>
        </div>
    </div><!-- container //  -->
</section>
<!-- ========================= SECTION CONTENT END// ========================= -->

<!-- Logout Modal-->
<div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
     aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">¿Est&aacute; seguro que desea salir?</h5>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">Asegurese de guardar correctamente todo su progreso.</div> <br>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancelar</button>
                <a class="btn btn-primary" href="/login">Salir</a>
            </div>
        </div>
    </div>
</div>

<!-- Notification Area Div -->
<div id="notification-area"></div>

<script src="/vendor/jquery/jquery.js"></script>
<script src="/assets/js/bootstrap.bundle.min.js" type="text/javascript"></script>
<script src="/assets/js/OverlayScrollbars.js" type="text/javascript"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/js/notification.js"></script>


<script>
    $(function () {
        //The passed argument has to be at least a empty object or a object with your desired options
        //$("body").overlayScrollbars({ });
        $("#items").height(552);
        $("#items").overlayScrollbars({
            overflowBehavior: {
                x: "hidden",
                y: "scroll"
            }
        });
        $("#cart").height(445);
        $("#cart").overlayScrollbars({});
    });
</script>

<script>
    function increaseQuantity(button, productId) {
        console.log("Incrementar");
        carritoItems.forEach(function(item) {
            console.log("Iterando item:", item);
            console.log("Original= " + productId + "  Item: " + item.producto.id)
            if (item.producto.id == productId) {
                if (item.producto.cantidad >= item.cantidad + 1) {
                    console.log("Cantidad producto: " + item.producto.cantidad)
                    console.log("Encontrado producto con ID:", productId);
                    item.cantidad += 1;
                    actualizarListaCarrito();
                    calcularTotales();
                }
                else {
                    new swal({
                        title: "¡Error!",
                        text: "Cantidad límite superada",
                        icon: "error",
                        button: "Cerrar"
                    }).then((value) => {
                        // Puedes agregar código adicional que se ejecutará después de que el usuario cierre la alerta
                        if (value) {
                            // El usuario hizo clic en el botón "Cerrar" o en cualquier área fuera de la alerta
                            console.log("Alerta cerrada");
                        }
                    });

                }
            }
        });
    }

    function decreaseQuantity(button, productId) {
        console.log("Decrementar");
        carritoItems.forEach(function(item) {
            console.log("Iterando item:", item);
            if (item.producto.id == productId && item.cantidad > 0) {
                console.log("Encontrado producto con ID:", productId);
                item.cantidad -= 1;
                if (item.cantidad === 0) {
                    console.log("Cantidad llegó a 0, eliminando elemento");
                    var index = carritoItems.indexOf(item);
                    if (index > -1) {
                        carritoItems.splice(index, 1);
                    }
                }
                actualizarListaCarrito();
                calcularTotales();
            }
        });
    }

</script>

<script th:inline="javascript">

    var botonesAgregarCarrito = document.querySelectorAll('.agregar-carrito');
    console.log("HOLAA");
    // Agrega un evento de clic a cada botón
    botonesAgregarCarrito.forEach(function(boton) {
        boton.addEventListener('click', function(event) {
            event.preventDefault(); // Evita que el enlace se comporte normalmente

            // Obtiene el ID del producto desde el atributo 'data-producto-id'
            var productoId = parseInt(this.getAttribute('data-producto-id'));
            console.log(productoId);

            // Llama a la función 'agregarAlCarrito' con el ID del producto
            agregarAlCarrito(productoId);
        });
    });

    var productos = /*[[${productos}]]*/ [];
    console.log(productos);
    var carritoItems = []; // Lista de carrito items

    function agregarAlCarrito(productId) {
        var productoEncontrado = productos.find(function(producto) {
            return producto.id === productId;
        });

        if (productoEncontrado) {
            var itemExistente = carritoItems.find(function(item) {
                return item.producto.id === productId;
            });

            if (itemExistente) {
                console.log("Producto Existente")
                if (itemExistente.producto.cantidad >= itemExistente.cantidad + 1) {
                    itemExistente.cantidad += 1;
                }
                else {
                    new swal({
                        title: "¡Error!",
                        text: "Cantidad límite superada",
                        icon: "error",
                        button: "Cerrar"
                    }).then((value) => {
                        // Puedes agregar código adicional que se ejecutará después de que el usuario cierre la alerta
                        if (value) {
                            // El usuario hizo clic en el botón "Cerrar" o en cualquier área fuera de la alerta
                            console.log("Alerta cerrada");
                        }
                    });
                }
            } else {
                carritoItems.push({ producto: productoEncontrado, cantidad: 1 });
            }

            // Actualiza la lista de carrito en la página
            actualizarListaCarrito();

            // Calcula y actualiza los totales
            calcularTotales();
        }
    }

    function actualizarListaCarrito() {
        console.log("Actualizar Carrito");
        var carritoHtml = '';
        carritoItems.forEach(function(item) {
            carritoHtml += `
            <tr>
                <td>
                    <figure class="media">
                        <div class="img-wrap">
                            <img src="${item.producto.foto == null ? "/img/posDefault.jpg" : item.producto.foto}" class="img-thumbnail img-xs img-fluid" />
                        </div>
                        <figcaption class="media-body">
                            <h6 class="title text-truncate">${item.producto.nombre}</h6>
                        </figcaption>
                    </figure>
                </td>
                <td class="text-center">
                    <div class="m-btn-group m-btn-group--pill btn-group mr-2" role="group" aria-label="...">
                        <button type="button" class="m-btn btn btn-default" onclick="increaseQuantity(this, '${item.producto.id}')">
                            <i class="fa fa-plus"></i>
                        </button>
                        <button type="button" class="m-btn btn btn-default quantity-element" disabled>${item.cantidad}</button>
                        <button type="button" class="m-btn btn btn-default" onclick="decreaseQuantity(this, '${item.producto.id}')">
                            <i class="fa fa-minus"></i>
                        </button>
                    </div>
                </td>
                <td>
                    <div class="price-wrap">
                        <var class="price">${item.producto.precio}</var>
                    </div> <!-- price-wrap .// -->
                </td>
                <td class="text-right">
                    <a href="#" class="btn btn-outline-danger btn-delete" onclick="eliminarProducto('${item.producto.id}')">
                        <i class="fa fa-trash"></i>
                    </a>
                </td>
            </tr>
        `;
        });

        $('#cart tbody').html(carritoHtml);
        enviarData()
    }

    function calcularTotales() {
        console.log("Actualizar Totales");

        var subTotal = 0;
        carritoItems.forEach(function(item) {
            subTotal += item.producto.precio * item.cantidad;
        });

        var total = subTotal;

        var subTotalFormateado = subTotal.toLocaleString('es-ES');
        var totalFormateado = total.toLocaleString('es-ES');

        var totalesHtml = `
        <dl class="dlist-align">
            <dt>Sub-Total:</dt>
            <dd class="text-right">$${subTotalFormateado}</dd>
        </dl>
        <dl class="dlist-align">
            <dt>Total:</dt>
            <dd class="text-right h4 b">$${totalFormateado}</dd>
        </dl>
        <div class="row">
    <div class="col-md-6">
        <a href="/pos/carrito/vaciar" class="btn btn-default btn-error btn-lg btn-block"
           style="background-color: #ef5f5f; color: white">
            <i class="fa-solid fa-right-to-bracket"></i>
            Eliminar
        </a>
    </div>
    <div class="col-md-6">
        <button class="btn btn-lg btn-block" style="background-color: #7570B3; color: white" onclick="facturar()">
            <i class="fa fa-shopping-bag"></i>
            Facturar
        </button>
    </div>
</div>

    `;

        $('#totalesContainer').html(totalesHtml);
    }

    function enviarData() {
        console.log("Enviando data al controlador...");

        // Construye el array de items a enviar
        var itemsData = [];
        carritoItems.forEach(function(item) {
            itemsData.push({
                productoId: item.producto.id,
                cantidad: item.cantidad
            });
        });

        // Realiza la petición AJAX
        $.ajax({
            type: 'POST',
            url: '/pos/carrito/enviar', // Cambia la URL por la correcta
            contentType: 'application/json',
            data: JSON.stringify(itemsData),
            success: function(response) {
                console.log("Respuesta del servidor:", response);
                // Maneja la respuesta del servidor si es necesario
            },
            error: function(error) {
                console.error("Error en la petición AJAX:", error);
                // Maneja el error si es necesario
            }
        });
    }

    function eliminarProducto(productoId) {
        let indexToRemove = -1;

        carritoItems.forEach(function(item, index) {
            console.log("Original= " + productoId + "  Item: " + item.producto.id)
            if (item.producto.id == productoId) {
                console.log(item);
                indexToRemove = index;
            }
        });

        if (indexToRemove !== -1) {
            carritoItems.splice(indexToRemove, 1);
            actualizarListaCarrito();
            calcularTotales();
        }
    }

    function facturar() {
        $.ajax({
            type: 'POST', // Puedes usar POST o GET según tu configuración
            url: '/pos/facturar', // La URL de tu controlador
            success: function(response) {
                new swal({
                    title: '¡Éxito!',
                    text: 'La factura se ha generado correctamente.',
                    icon: 'success'
                }).then(function() {
                    window.location.href = "/pos";
                });
            },
            error: function(response) {
                // Error en la solicitud AJAX
                new swal({
                    title: '¡Error!',
                    text: response.message,
                    icon: 'error'
                });
            }
        });
    }



</script>

<script th:inline="javascript">
    /*<![CDATA[*/
    function actualizarCategoria(categoria) {
        var productos = /*[[${productos}]]*/ [];
        var productosFiltrados = [];

        if (categoria && typeof categoria === 'string') {
            if (categoria.toUpperCase() === 'TODOS') {
                // Si se selecciona 'Todos', muestra todos los productos sin filtrar
                productosFiltrados = productos;
            } else {
                // Filtra los productos según la categoría
                productosFiltrados = productos.filter(function(producto) {
                    return producto.categoria && producto.categoria.toUpperCase() === categoria.toUpperCase();
                });
            }
        } else {
            // Manejo del caso en que categoria es null o no es una cadena
            // Por ejemplo, puedes mostrar un mensaje de error o tomar otra acción apropiada.
            console.error('La categoría es inválida.');
        }


        var productosContainer = document.getElementById("productos-container");
        productosContainer.innerHTML = '';

        productosFiltrados.forEach(function(producto) {
            productosContainer.innerHTML += `
        <div class="col-md-3 productos-table">
            <figure class="card card-product">
                <span class="badge-new categoria">${producto.categoria}</span>
                <div class="img-wrap">
                    <img src="${producto.foto == null ? "/img/posDefault.jpg" : producto.foto}" style="object-fit: cover; height: 100%">
                </div>
                <figcaption class="info-wrap">
                    <a href="#" class="title">${producto.nombre}</a>
                    <div class="action-wrap">
                        <button href="#" class="btn btn-sm float-right agregar-carrito" style="background-color: #7570B3; color: white" data-producto-id=${producto.id}>
                            <i class="fa fa-cart-plus"></i>
                        </button>
                        <div class="price-wrap h5">
                            <span class="price-new">${producto.precio}</span>
                        </div>
                    </div>
                </figcaption>
            </figure>
        </div>
    `;
        });

        var botonesAgregarCarrito = document.querySelectorAll('.agregar-carrito');
        // Agrega un evento de clic a cada botón
        botonesAgregarCarrito.forEach(function(boton) {
            boton.addEventListener('click', function(event) {
                event.preventDefault(); // Evita que el enlace se comporte normalmente

                // Obtiene el ID del producto desde el atributo 'data-producto-id'
                var productoId = parseInt(this.getAttribute('data-producto-id'));
                console.log(productoId);

                // Llama a la función 'agregarAlCarrito' con el ID del producto
                agregarAlCarrito(productoId);
            });
        });
    }
    /*]]>*/
</script>

<script th:inline="javascript">
    var edicionExitosa = /*[[${edicionExitosa}]]*/ null;

    if(edicionExitosa){
        notify('success', 'Su información de usuario ha sido modificada correctamente.');
    }
</script>



</body>
</html>